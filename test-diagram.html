<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D3 Diagram Test</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #1d232a; color: #a6adba; }
    #container { width: 100vw; height: 100vh; display: flex; flex-direction: column; }
    #controls { padding: 10px; background: #2a323c; display: flex; gap: 10px; align-items: center; }
    #controls button { padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; }
    #controls button:hover { background: #2563eb; }
    #info { padding: 10px; background: #2a323c; font-size: 12px; }
    #diagram { flex: 1; background: #1d232a; position: relative; }
    svg { width: 100%; height: 100%; display: block; }
    .node circle { cursor: pointer; }
    .node text { font-size: 10px; pointer-events: none; }
    .link { stroke: #666; stroke-width: 1.5; }
  </style>
</head>
<body>
  <div id="container">
    <div id="controls">
      <button id="btn-test">Run Test</button>
      <button id="btn-clear">Clear</button>
      <span id="status">Ready</span>
    </div>
    <div id="info">Click "Run Test" to render a simple force-directed graph</div>
    <div id="diagram">
      <svg id="svg"></svg>
    </div>
  </div>

  <script>
    const svgEl = document.getElementById('svg');
    const statusEl = document.getElementById('status');
    const infoEl = document.getElementById('info');
    const diagramEl = document.getElementById('diagram');

    let simulation = null;

    function log(msg) {
      console.log(msg);
      statusEl.textContent = msg;
    }

    function runTest() {
      log('Starting test...');

      // Clear
      d3.select(svgEl).selectAll('*').remove();
      if (simulation) simulation.stop();

      const width = diagramEl.clientWidth;
      const height = diagramEl.clientHeight;
      const centerX = width / 2;
      const centerY = height / 2;

      log(`Container size: ${width}x${height}, center: ${centerX},${centerY}`);
      infoEl.textContent = `Container: ${width}x${height}, Center: (${centerX}, ${centerY})`;

      // Test data
      const nodes = [
        { id: 'Root', isRoot: true },
        { id: 'Child1', isRoot: false },
        { id: 'Child2', isRoot: false },
        { id: 'Child3', isRoot: false },
        { id: 'GrandChild1', isRoot: false },
      ];

      const links = [
        { source: 'Root', target: 'Child1' },
        { source: 'Root', target: 'Child2' },
        { source: 'Root', target: 'Child3' },
        { source: 'Child1', target: 'GrandChild1' },
      ];

      const svg = d3.select(svgEl)
        .attr('width', width)
        .attr('height', height);

      const g = svg.append('g');

      // Zoom
      const zoom = d3.zoom()
        .scaleExtent([0.2, 4])
        .on('zoom', (event) => {
          g.attr('transform', event.transform);
        });
      svg.call(zoom);

      // Simulation centered at (centerX, centerY)
      simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(80))
        .force('charge', d3.forceManyBody().strength(-200))
        .force('center', d3.forceCenter(centerX, centerY))
        .force('collision', d3.forceCollide().radius(30));

      // Links
      const link = g.append('g')
        .selectAll('line')
        .data(links)
        .enter()
        .append('line')
        .attr('class', 'link');

      // Nodes
      const node = g.append('g')
        .selectAll('g')
        .data(nodes)
        .enter()
        .append('g')
        .attr('class', 'node')
        .call(d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended));

      node.append('circle')
        .attr('r', d => d.isRoot ? 25 : 20)
        .attr('fill', d => d.isRoot ? '#3b82f6' : '#374151')
        .attr('stroke', d => d.isRoot ? '#60a5fa' : '#6b7280')
        .attr('stroke-width', 2);

      node.append('text')
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('fill', 'white')
        .text(d => d.id);

      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);

        node.attr('transform', d => `translate(${d.x},${d.y})`);
      });

      function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
      }

      function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      }

      function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
      }

      log('Test running - simulation started');
    }

    document.getElementById('btn-test').addEventListener('click', runTest);
    document.getElementById('btn-clear').addEventListener('click', () => {
      d3.select(svgEl).selectAll('*').remove();
      if (simulation) simulation.stop();
      log('Cleared');
    });

    // Auto-run on load
    setTimeout(runTest, 100);
  </script>
</body>
</html>
